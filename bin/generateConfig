#!/usr/bin/php
<?php

use Aether\Aether;
use Aether\Config;
use Aether\AetherConfig;

if (file_exists(__DIR__.'/../vendor/autoload.php')) {
    require __DIR__.'/../vendor/autoload.php';
} else {
    require __DIR__.'/../../../autoload.php';
}

$basePath = getcwd();
$configPath = "{$basePath}/config";

if (! file_exists("{$configPath}/aether.config.xml")) {
    echo "Are you sure this is an Aether project?\n";
    echo "aether.config.xml is missing.\n";

    exit(1);
}

$files = [
    'aetherConfig' => "{$configPath}/autogenerated.config.xml",
    'config'       => "{$configPath}/compiled.php",
];

foreach ($files as $file) {
    if (file_exists($file)) {
        unlink($file);
    }
}

$aether = new Aether($basePath);

if (! $aether->isProduction()) {
    echo "> Hello, there. The days of generateConfig during development are over.\n";
    echo "> Honestly, you should probably run the following:\n";
    echo "> rm config/{autogenerated.config.xml,compiled.php}\n";
}

// 1) Save the compiled Aether XML config to disk...
$aether[AetherConfig::class]->saveToFile($files['aetherConfig']);

// 2) Save the compiled PHP config to disk...
$config = $aether[Config::class];
file_put_contents($files['config'], '<?php return '.var_export($config->all(), true).';');

echo "All done.\n";

echo "Environment: {$config['app.env']}\n";
