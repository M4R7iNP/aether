<?php

namespace Aether\Services;

use Exception;
use Aether\Config;
use Aether\AetherConfig;
use Aether\Exceptions\MissingFile;
use Aether\Exceptions\NoUrlRuleMatch;

class ConfigService extends Service
{
    public function register()
    {
        $this->registerAppConfig();

        $this->registerAetherConfig();
    }

    protected function registerAppConfig()
    {
        // Load the application config and bind it to the service locator, so
        // that we can easily access it anywhere in the code using the
        // `config()` helper function.
        $this->sl->set(
            'config',
            new Config($this->sl->get('projectRoot'))
        );
    }

    protected function registerAetherConfig()
    {
        $projectPath = $this->sl->get('projectRoot');

        if (!file_exists($configPath = $projectPath.'config/autogenerated.config.xml')) {
            $configPath = $projectPath.'config/aether.config.xml';
        }

        try {
            $aetherConfig = new AetherConfig($configPath);

            $aetherConfig->matchUrl(
                $this->sl->get('parsedUrl')
            );

            $this->sl->set('aetherConfig', $aetherConfig);
        } catch (MissingFile $e) {
            throw new Exception(
                'No configuration file for project found: '.$e->getMessage()
            );
        } catch (NoUrlRuleMatch $e) {
            throw new Exception(
                'No rule matched url in config file: '.$e->getMessage()
            );
        }
    }
}
